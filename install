#!/bin/sh

# create ~/bin if not exists
if [ ! -e $(dirname $HOME/bin) ]
then
    mkdir -p $HOME/bin
fi

# make and install programs
cd programs
for src in $(ls)
do
    cd $src && make -s && sudo make -s clean install && make -s clean && cd ..
done
cd ..

for script in $(ls shell)
do
    cp shell/$script $HOME/bin/
    chmod a+rx $HOME/bin/$script
done

# list of files and destination with : separation
oldIFS=$IFS
for dot in $(cat configs.list)
do
    IFS=':' 
    set -- $dot
    file=$1
    dest=$HOME/$2
    if [ -e $dest ]
    then
        mv $dest $dest.bak
    fi
    if [ ! -e $(dirname $dest) ]
    then
        mkdir -p $(dirname $dest)
    fi
    cp ./dotfiles/$file $dest
done
IFS=$oldIFS

for app in $(cat apps.list)
do
    res=$(dpkg-query --show --showformat='${db:Status-Status}\n' $app)
    if [ "$res" != "installed" ]
    then
        sudo apt install "$app"
    fi
done

# list of webapps tag:filename:url
oldIFS=$IFS
for dot in $(cat webapps.list)
do
    IFS=';' 
    set -- $dot
    tag=$1
    filename=$2
    url=$3
    echo "#!/bin/sh\nchromium-browser --disable-background-networking --class='$tag' -user-data-dir=$HOME/.$tag --app='$url'" > $HOME/bin/$filename
    chmod a+x $HOME/bin/$filename
done
IFS=$oldIFS

# Hack fonts
if [ ! -e $HOME/.fonts ]
then
    mkdir -p $HOME/.fonts
fi
cp ./assets/fonts/* $HOME/.fonts
fc-cache -fv > /dev/null
xrdb -merge $HOME/.Xresources
gsettings set org.gnome.desktop.interface monospace-font-name 'Hack 12'

# after installing xfce power manager, set tray icon
xfconf-query -c xfce4-power-manager -p /xfce4-power-manager/show-tray-icon -s 1

# install good looking icons for wicd and xfce4-power man
sudo cp ./assets/wicd-icons/* /usr/share/wicd/icons/hicolor/22x22/status/
sudo cp ./assets/xfpm/* /usr/share/icons/hicolor/22x22/status
sudo cp ./assets/blueman/* /usr/share/icons/hicolor/24x24/status

# install Dropbox
if [ ! -e $HOME/.dropbox ]
then
    wget -O /tmp/db.deb https://www.dropbox.com/download?dl=packages/ubuntu/dropbox_2015.10.28_amd64.deb && sudo dpkg -i /tmp/db.deb
fi

# install oh-my-zsh
if [ ! -e $HOME/.oh-my-zsh ]
then
    sh -c "$(wget https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh -O -)"
fi

# make xterm my default
sudo update-alternatives --set x-terminal-emulator /usr/bin/xterm

# make thunar default file manager
sudo update-alternatives --install /usr/bin/x-file-manager x-file-manager /usr/bin/thunar 1000
sudo update-alternatives --set x-file-manager /usr/bin/thunar